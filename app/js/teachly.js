!function(){"use strict";var a={"abstract":{}},b={"abstract":{}},c={},d={},e={};e.access=function(a,b,c,d){a.$on("$locationChangeStart",function(e,f){var g=c.getUserType(),h=f.data?f.data.user_type:null;g?"/login"!==b.path()||h?h&&g!==h&&(b.path("/dashboard"),a.$broadcast(d.events.access.forbidden)):b.path("/dashboard"):b.path("/login")})},e.access.$inject=["$rootScope","$location","session","constants"],e.app=function(){var a=-1!==window.location.href.indexOf("localhost"),b="teachly",c=["ngRoute","ngCookies","ui.calendar","ui.bootstrap",b+".controllers",b+".directives",b+".services"],d={protocol:"http",domain:"teachly-server.hushly.co.uk",port:"80"};return a&&(d.domain="localhost",d.port="1337"),{name:b,server:d,modules:c,getServerUrl:function(){return(d.protocol?d.protocol:"http")+"://"+d.domain+(d.port?":"+d.port:"")}}}(),e.routes=function(a,b){b.defaults.useXDomain=!0,a.when("/login",{templateUrl:"partials/login.html",controller:"login"}),a.when("/dashboard",{templateUrl:"partials/dashboard.html",controller:"dashboard"}),a.when("/calendar",{templateUrl:"partials/calendar.html",controller:"calendar"}),e.routes.api(a,"users"),e.routes.api(a,"lessons",{list:"partials/lessons.html"}),e.routes.api(a,"news"),e.routes.api(a,"subjects"),e.routes.api(a,"questions"),e.routes.api(a,"answers"),e.routes.api(a,"activities"),e.routes.api(a,"results"),e.routes.api(a,"logs"),a.when("/forums",{templateUrl:"partials/forums.html",controller:"forums"}),a.when("/lesson/:id",{templateUrl:"partials/lesson.html",controller:"lesson"}),a.when("/questions/list/:lesson_id",{templateUrl:"partials/section/list.html",controller:"questions"}),a.when("/questions/create/:lesson_id",{templateUrl:"partials/section/edit.html",controller:"questions"}),a.when("/questions/edit/:id/:lesson_id",{templateUrl:"partials/section/edit.html",controller:"questions"}),a.when("/answers/list/:question_id",{templateUrl:"partials/section/list.html",controller:"answers"}),a.when("/answers/create/:question_id",{templateUrl:"partials/section/edit.html",controller:"answers"}),a.when("/answers/edit/:id/:question_id",{templateUrl:"partials/section/edit.html",controller:"answers"}),a.when("/lessons/live/:id",{templateUrl:"partials/live.html",controller:"live"}),a.when("/results/:lesson_id",{templateUrl:"partials/results.html",controller:"results"}),a.otherwise({redirectTo:"/dashboard"})},e.routes.api=function(a,b,c){var d={list:"partials/section/list.html",view:"partials/section/view.html",edit:"partials/section/edit.html",create:"partials/section/edit.html",remove:"partials/section/remove.html"};"logs"===b&&(d.list="partials/logs.html"),angular.extend(d,c),a.when("/"+b,{templateUrl:d.list,controller:b,data:{user_type:1}}),a.when("/"+b+"/view/:id",{templateUrl:d.view,controller:b,data:{user_type:1}}),a.when("/"+b+"/edit/:id",{templateUrl:d.edit,controller:b,data:{user_type:1}}),a.when("/"+b+"/create",{templateUrl:d.create,controller:b,data:{user_type:1}}),a.when("/"+b+"/remove/:id",{templateUrl:d.remove,controller:b,data:{user_type:1}})},e.routes.$inject=["$routeProvider","$httpProvider"],a.abstract.create=function(b,c,d,e,f,g){function h(a){var b;for(b in a)"select"===a[b].value&&a[b].provider&&i(a[b],b)}function i(a,c){a.provider.getAll().success(function(a){b.types[c].options=j(a)}).error(console.error)}function j(a){var b={};return a.forEach(function(a){b[a.id]=a.title||a.name||"not found"}),b}a.abstract.init(b,d,e,g),c.$broadcast("breadcrumb:add",{label:g.name,path:"/"+g.name}),c.$broadcast("breadcrumb:add",{label:"Add"}),b.save={label:e.fetch("create"),handler:function(){g.service.add(b.item).success(function(){f.success(e.fetch(g.name+"_create_success")),history.go(-1)}).error(function(){f.error(e.fetch(g.name+"_create_error"))})}},delete b.actions.remove,b.types&&h(b.types)},a.abstract.edit=function(b,c,d,e,f,g){function h(a){var b;for(b in a)"select"===a[b].value&&a[b].provider&&i(a[b],b)}function i(a,c){a.provider.getAll().success(function(a){b.types[c].options=j(a)}).error(console.error)}function j(a){var b={};return a.forEach(function(a){b[a.id]=a.title||a.name||"not found"}),b}a.abstract.init(b,d,e,g),b.save={label:e.fetch("save"),handler:function(){g.service.save(g.id,b.item).success(function(){f.success(e.fetch(g.name+"_edit_success")),history.go(-1)}).error(function(){f.error(e.fetch(g.name+"_edit_error"))})}},g.service.getById(g.id).success(function(a){b.item=a,c.$broadcast("breadcrumb:add",{label:g.name,path:"/"+g.name}),c.$broadcast("breadcrumb:add",{label:"Edit "+(a.title||a.name||a.username)})}).error(function(a){console.log(a)}),b.types&&h(b.types)},a.abstract.getAction=function(a){for(var b=["edit","remove","view","create","join","start"],c=b.length,d=0;c>d;d++)if(-1!==a.indexOf(b[d]))return b[d]},a.abstract.init=function(a,b,c,d){a.id=d.id,a.fields=d.fields,a.path="#/"+d.name,a.item={},a.items=[],a.actions={},a.headers=[],a.types=d.types,a.fields.forEach(function(b){a.headers.push(c.fetch(b)),a.item[b]=""}),b.getAllowedActions(d.name).forEach(function(b){a.actions[b]={label:c.fetch(d.name+"_"+b)}})},a.abstract.list=function(b,c,d,e,f){a.abstract.init(b,d,e,f),b.headers.push(e.fetch("actions")),f.service[f.serviceMethod||"getAll"](f.serviceId).success(function(a){b.items=a,c.$broadcast("breadcrumb:add",{label:f.name})}).error(function(a){console.error(a)})},a.abstract.remove=function(b,c,d,e,f,g){a.abstract.init(b,d,e,g),b.confirmation={message:e.fetch(g.name+"_confirm_remove"),accept:e.fetch(g.name+"_accept_remove"),refuse:e.fetch(g.name+"_refuse_remove"),yes:function(){g.service.remove(g.id).success(function(){f.success(e.fetch(g.name+"_remove_success")),history.go(-1)}).error(function(){f.error(e.fetch(g.name+"_remove_error"))})},no:function(){history.go(-1)}},g.service.getById(g.id).success(function(a){b.item=a,c.$broadcast("breadcrumb:add",{label:g.name,path:"/"+g.name}),c.$broadcast("breadcrumb:add",{label:"Remove "+(a.title||a.name||a.username)})}).error(function(a){console.log(a)})},a.abstract.router=function(b,c,d,e,f,g){var h={service:g.service,serviceMethod:g.serviceMethod,serviceId:g.serviceId,name:g.name,fields:g.fields.edit,types:g.types,id:g.id};g.id||"create"===g.action?a.abstract[g.action]&&("create"===g.action&&(h.fields=g.fields.create),a.abstract[g.action](b,c,d,e,f,h)):(h.fields=g.fields.list,a.abstract.list(b,c,d,e,h))},a.abstract.view=function(b,c,d,e,f,g){a.abstract.init(b,d,e,g),g.service.getById(g.id).success(function(a){b.item=a,c.$broadcast("breadcrumb:add",{label:g.name,path:"/"+g.name}),c.$broadcast("breadcrumb:add",{label:a.title||a.name||a.username})}).error(function(a){console.log(a)})},a.activities=function(b,c,d,e,f,g,h,i,j){var k=a.abstract.getAction(d.path());a.abstract.router(b,c,g,f,h,{name:"activities",service:i,serviceMethod:e.id?"getForQuestion":null,serviceId:e.id?e.id:null,id:e.id,action:k,fields:{edit:["name","description","days","times"],create:["name","description","days","times"],list:["name","description","days","times"]},types:{days:{value:"days"},times:{value:"time"}}}),b.register=function(a){j.add({activity_id:a.id}).success(function(){h.success("Activity added to the calendar"),a.registered=!0}).error(function(){h.error("Failed to add activity to the calendar")})}},a.activities.$inject=["$scope","$rootScope","$location","$routeParams","i18n","permissions","toasts","activities","registrations"],a.addEvent=function(a,b,c){a.date=c,a.data={title:"",description:"",allDay:!1,recurring:"",start:"",end:""},a.ok=function(){b.close(a.data)},a.cancel=function(){b.dismiss("cancel")}},a.addEvent.$inject=["$scope","$modalInstance","date"],a.addResource=function(a,b){a.file="",a.ok=function(){return a.file?void b.close(a.file):void alert("You didn't type any file!")},a.cancel=function(){b.dismiss("cancel")}},a.addResource.$inject=["$scope","$modalInstance"],a.answers=function(b,c,d,e,f,g,h,i){var j=a.abstract.getAction(d.path());a.abstract.router(b,c,g,f,h,{name:"answers",service:i,serviceMethod:e.question_id?"getForQuestion":null,serviceId:e.question_id?e.question_id:null,id:e.id,action:j,fields:{edit:["answer","question_id","is_valid"],create:["answer","question_id","is_valid"],list:["answer"]},types:{is_valid:{value:"checkbox"}}}),e.question_id&&(b.filter="/"+e.question_id,("create"===j||"edit"===j)&&(b.item.question_id=e.question_id,b.hiddenFields={question_id:e.question_id}))},a.answers.$inject=["$scope","$rootScope","$location","$routeParams","i18n","permissions","toasts","answers"],a.breadcrumb=function(a,b){function c(){d=b.path(),a.crumbs=[],"/dashboard"!==d&&"/login"!==d&&a.crumbs.push({label:"Dashboard",path:"/dashboard"}),"/dashboard"===d&&a.crumbs.push({label:"Dashboard"})}var d=b.path();a.crumbs=[],c(),a.$on("$locationChangeSuccess",c),a.$on("breadcrumb:add",function(b,c){a.crumbs.push(c)})},a.breadcrumb.$inject=["$scope","$location"],a.calendar=function(a,b,c,d,e,f,g){a.events=[],a.config={height:450,editable:!0,dayClick:function(b){c.open({templateUrl:"partials/modals/addEvent.html",controller:"addEvent",resolve:{date:function(){return b}}}).result.then(function(c){var g=b.getFullYear(),h=b.getMonth(),i=b.getDate(),j=new Date(c.start),k=j.getHours(),l=j.getMinutes(),m=new Date(c.end),n=m.getHours(),o=m.getMinutes();e.add({user_id:f.getId(),title:c.title,start:new Date(g,h,i,k,l),end:new Date(g,h,i,n,o),allDay:c.allDay}).success(function(){a.events.push([{title:c.title,start:new Date(g,h,i,k,l),end:new Date(g,h,i,n,o),allDay:c.allDay}]),d.success("Event added")}).error(function(){d.error("Failed to add event! Please try again.")})},function(){})},eventClick:function(a){c.open({templateUrl:"partials/modals/viewEvent.html",controller:"viewEvent",resolve:{item:function(){return a}}})},eventDrop:function(){console.log(arguments)},eventResize:function(){console.log(arguments)}},e.getForUser().success(function(b){a.events.push(b)}).error(console.error),g.query().success(function(b){var c=[],d=[];b.forEach(function(a){a.lesson&&c.push(a.lesson),a.activity&&d.push(a.activity)}),a.events.push(c),a.events.push(d)}).error(console.error),b.$broadcast("breadcrumb:add",{label:"Calendar"})},a.calendar.$inject=["$scope","$rootScope","$modal","toasts","events","session","calendar"],a.dashboard=function(a,b,c){var d,e,f=c.get("session").getId();if(a.user_type=c.get("session").getUserType(),a.sections=c.get("permissions").getAllowedSections(),delete a.sections.answers,delete a.sections.questions,delete a.sections.logs,delete a.sections.activities,delete a.sections.subjects,delete a.sections.news,a.data={},a.teachers=[],a.students=[],a.lessons=[],a.user_type<3)for(d in a.sections)e=c.get(d),e&&!function(b,c){b.getOverview(2==a.user_type?f:null).success(function(b){a.data[c]=b}).error(function(a){console.log(a)})}(e,d);1==a.user_type&&(e=c.get("users"),e.raw("/users/teachers").then(function(b){a.teachers=b.data}),e.raw("/users/students").then(function(b){a.students=b.data})),3==a.user_type&&(e=c.get("lessons"),e.raw("/lessons/student?student_id="+f).then(function(b){a.lessons=b.data}))},a.dashboard.$inject=["$scope","$rootScope","$injector"],a.forums=function(a,b,c,d,e,f,g){a.forums=[],a.discuss=function(b){c.open({templateUrl:"partials/modals/discussion.html",controller:"startDiscussion",resolve:{reply:function(){return!!b}}}).result.then(function(c){var h={user_id:g.getId(),lesson_id:0,message:c,author:g.getUsername(),reply_id:b||0};d.add(h).success(function(){d.getForLesson(0).success(function(b){a.forums=b}).error(function(){e.error(f.fetch("forums_fetch_error"))})}).error(function(){e.error("Starting discussion failed!")})},function(){})},d.getForLesson(0).success(function(b){a.forums=b}).error(function(){e.error(f.fetch("forums_fetch_error"))}),b.$broadcast("breadcrumb:add",{label:f.fetch("forums")})},a.forums.$inject=["$scope","$rootScope","$modal","forums","toasts","i18n","session"],a.lesson=function(a,b,c,d,e,f,g,h,i){a.lesson={},a.resources=[],a.forums=[],a.news=[],a.addNews=function(){d.open({templateUrl:"partials/modals/resource.html",controller:"addResource"}).result.then(function(){},function(){})},a.addResource=function(){d.open({templateUrl:"partials/modals/resource.html",controller:"addResource"}).result.then(function(){},function(){})},a.canAddResources=g.getUserType()<3,a.discuss=function(b){d.open({templateUrl:"partials/modals/discussion.html",controller:"startDiscussion",resolve:{reply:function(){return!!b}}}).result.then(function(d){var e={user_id:g.getId(),lesson_id:a.lesson.id,message:d,author:g.getUsername(),reply_id:b||0};h.add(e).success(function(){h.getForLesson(c.id).success(function(b){a.forums=b}).error(function(){f.error(i18n.fetch("forums_fetch_error"))})}).error(function(){f.error("Starting discussion failed!")})},function(){})},a.signUp=function(b){e.register({lesson_id:b,student_id:g.getId()}).success(function(){a.lesson.signed=!0}).error(function(){f.error("Sign up failed!")})},i.getForLesson(c.id).success(function(b){a.news=b}).error(console.error),h.getForLesson(c.id).success(function(b){a.forums=b}).error(function(){f.error(i18n.fetch("forums_fetch_error"))}),e.single(c.id).success(function(c){a.lesson=c,b.$broadcast("breadcrumb:add",{label:"Lessons",path:"/lessons"}),b.$broadcast("breadcrumb:add",{label:c.title})}).error(function(){f.error(i18n.fetch("lessons_fetch_error"))})},a.lesson.$inject=["$scope","$rootScope","$routeParams","$modal","lessons","toasts","session","forums","news"],a.lessons=function(b,c,d,e,f,g,h,i,j,k){a.abstract.router(b,c,g,f,h,{name:"lessons",service:i,id:e.id,action:a.abstract.getAction(d.path()),fields:{edit:["title","subject_id","start_date","start_time","published"],create:["title","subject_id","start_date","start_time","published"],list:["title","start_date","start_time"]},types:{subject_id:{value:"select",provider:k},start_date:{value:"date"},start_time:{value:"time"},published:{value:"checkbox"}}}),b.signUp=function(a){i.register({lesson_id:a,student_id:j.getId()}).success(function(){b.items.forEach(function(b){b.id==a&&(b.signed=!0)})}).error(function(){h.error("Sign up failed!")})},g.can("view","questions")&&(b.actions.extra={getUrl:function(a){return"/questions/list/"+a},label:"View questions"}),io.socket.on("lessons",function(a){var c=null;"updated"===a.verb&&(b.items.forEach(function(d,e){d.id==a.data.id&&(c=!0,a.data.published||a.data.initialized||a.data.started?angular.extend(b.items[e],a.data):a.data.published&&0!=a.data.published||b.items.splice(e,1))}),c||(b.items.push(a.data),c=null),b.$apply()),"created"===a.verb&&(b.items.push(a.data),b.$apply()),"destroyed"===a.verb&&b.items.forEach(function(c,d){c.id===parseInt(a.id)&&(b.items.splice(d,1),b.$apply())})}),io.socket.get("/lessons",function(){})},a.lessons.$inject=["$scope","$rootScope","$location","$routeParams","i18n","permissions","toasts","lessons","session","subjects"],a.live=function(a,b,c,d,e,f,g,h,i,j,k){function l(b){a.user_type=d.getUserType(),a.lesson=b,io.socket.on("room",function(b){"addedTo"===b.verb&&a.connected++,"removedFrom"===b.verb&&a.connected--,a.$apply()}),a.$on("$locationChangeStart",m),2==a.user_type?n(b):o(b)}function m(){if(q&&!r){var b=confirm(f.fetch("live_window_close_warning"));b&&(2==a.user_type&&io.socket.post("/message/end_lesson",{room:q}),io.socket.delete("/room/"+q+"/participants",{id:window.me.id}))}}function n(b){h.getForLesson(a.lesson.id).success(function(d){var f=0;a.questions=d,io.socket.get("/registrations?lesson_id="+a.lesson.id,function(b){a.signed_up=b.length,a.$apply()}),a.end={label:"End lesson",show:!1,handler:function(){g.save(a.lesson.id,{given:"true"}).success(function(){r=!0,io.socket.post("/message/end_lesson",{room:q}),k.store("ending",{lesson_id:b.id}),c.path("/results/"+a.lesson.id)}).error(function(){e.error("Failed to save lesson state")})}},a.next={label:"Next question",show:!1,handler:function(){a.questions[f].active=!0,a.questions[f].answered=0,a.questions[f-1]&&(a.questions[f-1].active=!1,a.questions[f-1].used=!0),io.socket.post("/message/question",{room:q,question:a.questions[f]}),k.store("asking",{lesson_id:b.id,question_id:a.questions[f].id}),i.getForQuestion(a.questions[f].id).success(function(b){a.answers=b}).error(function(){e.error("Failed to retrieve answers")}),f++,a.questions[f]||(a.next.show=!1,a.end.show=!0)}},g.initialize(a.lesson.id).success(function(){k.store("initializing",{lesson_id:b.id}),a.start.show=!0}).error(function(){e.error("Lesson initialization failed!")}),io.socket.post("/room",{name:b.id},function(b){io.socket.post("/room/"+b.id+"/participants",{id:window.me.id},function(){q=b.id,a.start.show=!0,a.$apply()})}),a.start.handler=function(){g.start(a.lesson.id),a.next.show=!0,a.start.show=!1}}).error(function(){e.error("lessons_questions_error")}),io.socket.on("results",function(c){var d;"created"===c.verb&&c.data.lesson_id==b.id&&(d=p(c.data.question_id),d&&d.answered++),a.$apply()}),io.socket.get("/results",function(){})}function o(b){var f=!1,g=null;a.question="Please wait until the lesson starts.",a.selectAnswer=function(c){f?e.warning("You have already selected an answer!"):(a.answers[c].selected=!0,f=!0,j.add({lesson_id:b.id,question_id:g,teacher_id:a.lesson.user_id,user_id:d.getId(),user_answer_id:a.answers[c].id}),k.store("answering",{lesson_id:b.id,question_id:g,answer_id:a.answers[c].id}))},io.socket.on("room",function(d){"created"===d.verb&&d.data.name==b.id&&io.socket.post("/room/"+d.data.id+"/participants",{id:window.me.id},function(){q=d.data.id}),"messaged"===d.verb&&(d.data.q&&(a.answers=[],f=!1,a.question=d.data.q.question,g=d.data.q.id,i.getForQuestion(g).success(function(b){a.answers=b}).error(function(){e.error("Failed to retrieve answers")})),d.data.end&&(r=!0,a.answers=[],a.question="Lesson ended!",c.path("/results/"+a.lesson.id))),a.$apply()}),io.socket.get("/room",{where:{name:b.id}},function(a){(a||[]).forEach(function(a){a.name==b.id&&(io.socket.post("/room/"+a.id+"/participants",{id:window.me.id}),k.store("joining",{lesson_id:b.id}))})})}function p(b){for(var c=a.questions,d=c.length,e=0;d>e;e++)if(c[e].id==b)return c[e];return null}var q,r=!1;a.signed_up=0,a.connected=0,a.lesson={},a.progress=0,a.user_type=null,a.answers=[],a.start={label:"Start",show:!1},g.getById(b.id).success(l).error(function(){e.error(f.fetch("lessons_fetch_error"))})},a.live.$inject=["$scope","$routeParams","$location","session","toasts","i18n","lessons","questions","answers","results","logs"],a.login=function(a,b,c,d,e,f){a.username="",a.password="",a.errors={username:!1,password:!1},a.submit=function(){d.login(a.username,a.password).success(function(d){a.errors.username=!1,a.errors.password=!1,e.create(d),b.$broadcast(f.events.user.login),c.path("/dashboard")}).error(function(b){"PASSWORD"===b.error&&(a.errors.username=!1,a.errors.password=!0),"NOT_FOUND"===b.error&&(a.errors.username=!0,a.errors.password=!0)})}},a.login.$inject=["$scope","$rootScope","$location","users","session","constants"],a.logs=function(b,c,d,e,f,g,h,i){a.abstract.router(b,c,g,f,h,{name:"logs",service:i,id:e.id,action:[],fields:{list:["name","user_type","event","lesson"]}})},a.logs.$inject=["$scope","$rootScope","$location","$routeParams","i18n","permissions","toasts","logs"],a.main=function(){io.socket.on("hello",function(a){window.me=a})},a.main.$inject=[],a.news=function(b,c,d,e,f,g,h,i,j,k){a.abstract.router(b,c,g,h,i,{name:"news",service:f,id:e.id,action:a.abstract.getAction(d.path()),fields:{edit:["title","message","subject_id","user_type","lesson_id"],create:["title","message","subject_id","user_type","lesson_id"],list:["title","updatedAt"]},types:{message:{value:"textarea"},subject_id:{value:"select",provider:j},lesson_id:{value:"select",provider:k},user_type:{value:"select",options:{1:h.fetch("school"),2:h.fetch("teacher"),3:h.fetch("student")}}}})},a.news.$inject=["$scope","$rootScope","$location","$routeParams","news","permissions","i18n","toasts","subjects","lessons"],a.questions=function(b,c,d,e,f,g,h,i){var j=a.abstract.getAction(d.path());a.abstract.router(b,c,g,f,h,{name:"questions",service:i,serviceMethod:e.lesson_id?"getForLesson":null,serviceId:e.lesson_id?e.lesson_id:null,id:e.id,action:j,fields:{edit:["question","lesson_id"],create:["question","lesson_id"],list:["question"]}}),e.lesson_id&&(b.filter="/"+e.lesson_id,("create"===j||"edit"===j)&&(b.item.lesson_id=e.lesson_id,b.hiddenFields={lesson_id:e.lesson_id})),g.can("view","answers")&&(b.actions.extra={getUrl:function(a){return"/answers/list/"+a},label:"View answers"})},a.questions.$inject=["$scope","$rootScope","$location","$routeParams","i18n","permissions","toasts","questions"],a.resources=function(){},a.resources.$inject=["$scope","resources"],a.results=function(a,b,c,d,e,f,g,h,i){function j(b){for(var c=a.results.length,d=0;c>d;d++)if(parseInt(a.results[d].question_id)===parseInt(b))return a.results[d].user_answer_id}function k(){a.isTeacher?f.getForLesson(m).success(function(b){a.results=b,a.questions.forEach(function(b){a.results.forEach(function(c){if(parseInt(c.question_id)===parseInt(b.id)){b.participants||(b.participants=0,b.valids=0),b.participants++;var d=a.answers[b.id];d.forEach(function(a){parseInt(c.user_answer_id)===parseInt(a.id)&&b.valids++})}})})}).error(function(){g.error(h.fetch("results_fetch_error"))}):f.getForStudent(m,i.getId()).success(function(b){a.results=b}).error(function(){g.error(h.fetch("results_fetch_error"))})}var l=i.getUserType(),m=b.lesson_id;a.isHidden=!0,a.isTeacher="2"===l,a.isStudent="3"===l,a.results=[],a.answers={},a.lesson={},a.user_score=0;var n={};a.getAnswer=function(b){if(n[b])return n[b];var c=a.answers[b];if(c){for(var d=j(b),e=c.length,f=0;e>f;f++)if(parseInt(c[f].id)===parseInt(d))return"true"===c[f].is_valid&&a.user_score++,n[b]=c[f],c[f];return""}},c.getById(m).success(function(b){a.lesson=b,d.getForLesson(b.id).success(function(b){var c=b.length;a.questions=b,b.forEach(function(b){e.getForQuestion(b.id).success(function(d){a.answers[b.id]=d,d.is_valid&&a.user_score++,c--,0===c&&(a.isHidden=!0,k())}).error(function(){g.error(h.fetch("answers_fetch_error"))})})}).error(function(){g.error(h.fetch("questions_fetch_error"))})}).error(function(){g.error(h.fetch("lessons_fetch_error"))})},a.results.$inject=["$scope","$routeParams","lessons","questions","answers","results","toasts","i18n","session"],a.sections=function(a,b,c,d,e){function f(){a.sections=[],(g[d.getUserType()]||[]).forEach(function(b){a.sections.push({label:e.fetch(b),path:"/"+b})})}var g={1:["calendar","news","subjects","lessons","activities","forums","users","logs"],2:["calendar","news","lessons","activities","forums"],3:["calendar","news","lessons","activities","forums"]};a.sections=[],f(),b.$on(c.events.user.login,function(){f()}),b.$on(c.events.user.logout,function(){a.sections=[]})},a.sections.$inject=["$scope","$rootScope","constants","session","i18n"],a.startDiscussion=function(a,b,c){a.message="",a.reply=c,a.update=function(b){a.message=b},a.ok=function(){return a.message?void b.close(a.message):void alert("You didn't type any message!")},a.cancel=function(){b.dismiss("cancel")}},a.startDiscussion.$inject=["$scope","$modalInstance","reply"],a.subjects=function(b,c,d,e,f,g,h,i){a.abstract.router(b,c,g,h,i,{name:"subjects",service:f,id:e.id,action:a.abstract.getAction(d.path()),fields:{edit:["title","description"],create:["title","description"],list:["title","description"]},types:{description:{value:"textarea"}}})},a.subjects.$inject=["$scope","$rootScope","$location","$routeParams","subjects","permissions","i18n","toasts"],a.toasts=function(a,b,c){var d=3500,e=1e3;a.items=[],a.close=function(b){c.cancel(a.items[b].timeout),a.items[b].enable=!1,c(function(){a.items.splice(b,1)},e)},b.$on("toast",function(b,f){a.items.push(f),f.enable=!0,c(function(){f.enable=!1,c(function(){a.items.forEach(function(b,c){b===f&&a.items.splice(c,1)})},e)},d)})},a.toasts.$inject=["$scope","$rootScope","$timeout"],a.toolbar=function(a,b,c,d,e){var f=c.path().split("/");a.active=f[1],a.isCollapsed=!0,a.id=d.getId()||null,a.username=d.getUsername()||"",a.display=!1,a.logout=function(){d.destroy(),a.display=!1,a.username="",a.sections=[],c.path("/login"),b.$broadcast(e.events.user.logout)},b.$on(e.events.user.login,function(){a.display=!0,a.username=d.getUsername()})},a.toolbar.$inject=["$scope","$rootScope","$location","session","constants"],a.users=function(b,c,d,e,f,g,h,i){a.abstract.router(b,c,g,f,h,{name:"users",service:i,id:e.id,action:a.abstract.getAction(d.path()),fields:{edit:["first_name","last_name","username","user_type"],create:["first_name","last_name","username","password","user_type"],list:["first_name","last_name","username","user_type"]},types:{user_type:{value:"select",options:{1:f.fetch("school"),2:f.fetch("teacher"),3:f.fetch("student")}}}})},a.users.$inject=["$scope","$rootScope","$location","$routeParams","i18n","permissions","toasts","users"],a.viewEvent=function(a,b,c){a.item=c,a.ok=function(){b.close()}},a.viewEvent.$inject=["$scope","$modalInstance","item"],d.daysRender=function(){return{restrict:"A",link:function(a,b,c){var d,e={},f=[];try{e=JSON.parse(c.daysRender)}catch(g){}for(d in e)f.push('<span class="text-capitalize">'+d+"</span>");b.html(f.join(", "))}}},d.dayspicker=function(){function a(a,d){var e=d.value?JSON.parse(d.value):{},g=angular.element(d).parents()[0].getElementsByTagName("label");angular.element(g).remove(),f.forEach(function(b){var f=document.createElement("input"),g=document.createElement("label");g.className="text-capitalize text-center margin-right",f.className="checkbox",f.style.margin="0 auto",f.type="checkbox",f.name="days[]",f.value=b,f.checked=e[b],angular.element(g).text(b).append(f).on("click",function(){c(this,d)}),a.append(g)}),b(d)}function b(a){var b=angular.element(a).parents()[0].getElementsByTagName("label"),c=a.value?JSON.parse(a.value):{};angular.forEach(b,function(a){var b=a.getElementsByTagName("input")[0];c[b.value]&&b.setAttribute("checked","checked")})}function c(a,b){var c=b.value?JSON.parse(b.value):{};a.type||(a=a.getElementsByTagName("input")[0]),a.checked?c[a.value]=!0:c[a.value]&&delete c[a.value],b.value=JSON.stringify(c),e.item.days=b.value}function d(a){var b=a[0].getElementsByTagName("input");angular.forEach(b,function(a){angular.element(a).off("click")})}var e,f=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"];return{restrict:"AE",link:function(b,c){var f=c.children()[0];e=b,b.$watch("item.days",function(b){f.value=b,a(c,f)}),b.$on("$destroy",function(){d(c)})}}},d.dayspicker.$inject=[],d.lessonButton=function(a){function b(a){var b,c=[];for(b in f)c.push(f[b]);a.removeClass(c.join(" ")),d(a)}function c(a){a.addClass("ng-hide")}function d(a){a.removeClass("ng-hide")}var e=a.getUserType(),f={join:"glyphicon-plus",live:"glyphicon-play",results:"glyphicon-stats",started:"glyphicon-ban-circle",signed:"glyphicon-ok"};return{restrict:"AC",link:function(a,g,h){var i=angular.element(g[0].getElementsByClassName("glyphicon")),j=angular.element(g[0].getElementsByClassName("lesson-label"));c(g),a.$watch("item.started",function(a){!a||0!=h.given&&"false"!=h.given||(j.text("Started"),b(i),i.addClass(f.started),g.attr("href",""),d(g),g.off("click"))},!0),a.$watch("item.signed",function(a){!a||0!=h.given&&"false"!=h.given||(j.text("Signed up"),b(i),i.addClass(f.signed),g.attr("href",""),d(g),g.off("click"),g.attr("disabled",!0))},!0),a.$watch("item.initialized",function(a){!a||3!=e||0!=h.given&&"false"!=h.given||(j.text("Join"),b(i),i.addClass(f.live),g.attr("href","#/lessons/live/"+h.index),d(g),g.off("click"),g.attr("disabled",!1))},!0),a.$watch("item.given",function(a){1!=a&&"true"!=a||2!=e&&(3!=e||"true"!=h.taken&&1!=h.taken)||(j.text("Results"),b(i),i.addClass(f.results),g.attr("href","#/results/"+h.index),d(g),g.off("click"))},!0),h.given&&"false"!=h.given||h.started&&"false"!=h.started||3!=e&&"3"!=e||"false"!=h.signed&&h.signed||(j.text("Sign up"),i.addClass(f.join),d(g),g.on("click",function(){g.off("click"),c(i),j.text("Signing up"),j.addClass("disabled"),a[h.callback](h.index)})),h.given&&"false"!=h.given||2!=e||"true"!=h.published&&1!=h.published||(j.text("Initialize"),i.addClass(f.live),g.attr("href","#/lessons/live/"+h.index),d(g),g.off("click"))}}},d.lessonButton.$inject=["session"],d.pie=function(){var a=100;return{restrict:"A",link:function(b,c,d){var e=Raphael(c[0]),f=parseInt(d.radius)||a;e.setSize(parseInt(d.width)||4*f,parseInt(d.height)||2*f),d.$observe("values",function(){var a,b;try{a=JSON.parse(d.legends),b=JSON.parse(d.values)}catch(c){}b&&(b.forEach(function(c,d){0===c&&(b.splice(d,1),a.splice(d,1))}),a?e.piechart(f,f,f,b,{legend:a}):e.piechart(f,f,f,b))})}}},c["en-GB"]={actions:"Actions",save:"Save",create:"Create",users:"Users",users_add:"Add a new user",users_remove:"Remove user",users_edit:"Edit user",users_view:"View user",users_confirm_remove:"Are you sure you want to delete this user?",users_accept_remove:"Accept",users_refuse_remove:"Cancel",users_edit_success:"User edited with success",users_edit_error:"Failed to edit the user",users_create_success:"User created with success",users_create_error:"Failed to create the user",users_remove_success:"User removed with success",users_remove_error:"Failed to remove the user",user_type:"User type",username:"Username",first_name:"First name",last_name:"Last name",password:"Password",school:"School",teacher:"Teacher",student:"Student",name:"Name",event:"Event",forums:"Forums",lesson:"Lesson",lessons:"Lessons",lessons_add:"Add a new lesson",lessons_remove:"Remove lesson",lessons_edit:"Edit lesson",lessons_view:"View lesson",lessons_start:"Start lesson",lessons_join:"Join lesson",lessons_results:"View results",lessons_confirm_remove:"Are you sure you want to delete this lesson?",lessons_accept_remove:"Accept",lessons_refuse_remove:"Cancel",lessons_edit_success:"Lesson edited with success",lessons_edit_error:"Failed to edit the lesson",lessons_create_success:"Lesson created with success",lessons_create_error:"Failed to create the lesson",lessons_remove_success:"Lesson removed with success",lessons_remove_error:"Failed to remove the lesson",lessons_fetch_error:"Failed to retrieve the lesson",lessons_questions_error:"Failed to retrieve the questions for this lesson",title:"Title",start_date:"Start date",start_time:"Start time",user_id:"User id",published:"Publish",registrations:"Registrations",questions:"Questions",questions_add:"Add a new question",questions_remove:"Remove question",questions_edit:"Edit question",questions_view:"View question",questions_confirm_remove:"Are you sure you want to delete this question?",questions_accept_remove:"Accept",questions_refuse_remove:"Cancel",questions_edit_success:"Question edited with success",questions_edit_error:"Failed to edit the question",questions_create_success:"Question created with success",questions_create_error:"Failed to create the question",questions_remove_success:"Question removed with success",questions_remove_error:"Failed to remove the question",questions_fetch_error:"Failed to retrieve the question(s)",question:"Question",lesson_id:"Lesson",answers:"Answers",answers_add:"Add a new answer",answers_remove:"Remove answer",answers_edit:"Edit answer",answers_view:"View answer",answers_confirm_remove:"Are you sure you want to delete this answer?",answers_accept_remove:"Accept",answers_refuse_remove:"Cancel",answers_edit_success:"Answer edited with success",answers_edit_error:"Failed to edit the answer",answers_create_success:"Answer created with success",answers_create_error:"Failed to create the answer",answers_remove_success:"Answer removed with success",answers_remove_error:"Failed to remove the answer",answers_fetch_error:"Failed to retrieve the answer(s)",answer:"Answer",question_id:"Question id",is_valid:"Is valid",activities:"Activities",activities_add:"Add a new activity",activities_remove:"Remove activity",activities_edit:"Edit activity",activities_view:"View activity",activities_register:"Sign up",activities_confirm_remove:"Are you sure you want to delete this activity?",activities_accept_remove:"Accept",activities_refuse_remove:"Cancel",activities_edit_success:"Activity edited with success",activities_edit_error:"Failed to edit the activity",activities_create_success:"Activity created with success",activities_create_error:"Failed to create the activity",activities_remove_success:"Activity removed with success",activities_remove_error:"Failed to remove the activity",activities_fetch_error:"Failed to retrieve the activities",news:"News",news_add:"Add a new entry",news_remove:"Remove entry",news_edit:"Edit entry",news_view:"View entry",news_register:"Sign up",news_confirm_remove:"Are you sure you want to delete this entry?",news_accept_remove:"Accept",news_refuse_remove:"Cancel",news_edit_success:"Entry edited with success",news_edit_error:"Failed to edit the entry",news_create_success:"Entry created with success",news_create_error:"Failed to create the entry",news_remove_success:"Entry removed with success",news_remove_error:"Failed to remove the entry",news_fetch_error:"Failed to retrieve the news",subjects:"Subjects",subjects_add:"Add a new subject",subjects_remove:"Remove subject",subjects_edit:"Edit subject",subjects_view:"View subject",subjects_register:"Sign up",subjects_confirm_remove:"Are you sure you want to delete this subject?",subjects_accept_remove:"Accept",subjects_refuse_remove:"Cancel",subjects_edit_success:"Subject edited with success",subjects_edit_error:"Failed to edit the subject",subjects_create_success:"Subject created with success",subjects_create_error:"Failed to create the subject",subjects_remove_success:"Subject removed with success",subjects_remove_error:"Failed to remove the subject",subjects_fetch_error:"Failed to retrieve the subjects",logs:"Logs",live_window_close_warning:"Are you sure you want to leave the lesson?",forums_fetch_error:"Failed to retrieve the lesson",results_fetch_error:"Failed to retrieve the results",dashboard:"Dashboard",description:"Description",days:"Days",times:"Times",calendar:"Calendar",message:"Message",subject_id:"Subject",activity_id:"Activity",createdAt:"Created at",updatedAt:"Updated at"},b.abstract.api=function(a,b){return{raw:function(b){return a.query(b)
},getAll:function(){return a.query("/"+b)},getById:function(c){return a.query("/"+b+"/"+c)},add:function(c){return a.query("/"+b+"/create",c)},save:function(c,d){return a.query("/"+b+"/update/"+c,d)},remove:function(c){return a.query("/"+b+"/destroy/"+c)},getOverview:function(c){return a.query("/"+b+"/overview"+(c?"?id="+c:""))}}},b.activities=function(a){return angular.extend(b.abstract.api(a,"activities"))},b.activities.$inject=["restful"],b.answers=function(a){return angular.extend(b.abstract.api(a,"answers"),{getForQuestion:function(b){return a.query("/answers",{question_id:b})}})},b.answers.$inject=["restful"],b.calendar=function(a,b){return{query:function(){var c=parseInt(b.getUserType());return 3===c?a.query("/calendar/student?student_id="+b.getId()):2===c?a.query("/calendar/teacher?user_id="+b.getId()):1===c?a.query("/calendar/school?user_id="+b.getId()):void 0}}},b.calendar.$inject=["restful","session"],b.constants=function(){return{events:{user:{login:"user:login",logout:"user:logout"},access:{forbidden:"access:forbidden"}},i18n:{not_found:"NOT_FOUND:i18n:"}}},b.events=function(a,c){return angular.extend(b.abstract.api(a,"events"),{getForUser:function(){return a.query("/events?user_id="+c.getId())}})},b.events.$inject=["restful","session"],b.forums=function(a){return angular.extend(b.abstract.api(a,"forum"),{getForLesson:function(b){return a.query("/forum",{lesson_id:b})}})},b.forums.$inject=["restful"],b.i18n=function(a){var b="en-GB",d=b;return{fetch:function(e){return c[d][e]||c[b][e]||a.i18n.not_found+e}}},b.i18n.$inject=["constants"],b.lessons=function(a,c){return angular.extend(b.abstract.api(a,"lessons"),{add:function(b){return b.user_id=c.getId(),a.query("/lessons/create",b)},single:function(b){return a.query("/lesson/"+b,{user_type:c.getUserType(),user_id:c.getId()})},save:function(b,d){return d.user_id=c.getId(),a.query("/lessons/update/"+b,d)},register:function(b){return a.query("/registrations/create",b)},getAll:function(){return 2==c.getUserType()?a.query("/lessons",{user_type:c.getUserType(),user_id:c.getId()}):a.query("/lessons",{user_type:c.getUserType(),user_id:c.getId()})},initialize:function(a){return this.save(a,{initialized:!0,id:a})},start:function(a){return this.save(a,{started:!0,id:a})}})},b.lessons.$inject=["restful","session"],b.logs=function(a,c){var d=b.abstract.api(a,"logs");return d.store=function(a,b){var e={user_id:c.getId(),user_type:c.getUserType(),event:a};return angular.extend(e,b||{}),d.add(e)},d},b.logs.$inject=["restful","session"],b.news=function(a,c){return angular.extend(b.abstract.api(a,"news"),{add:function(b){return b.user_id=c.getId(),a.query("/news/create",b)},getForActivity:function(b){return a.query("/news",{activity_id:b})},getForLesson:function(b){return a.query("/news",{lesson_id:b})}})},b.news.$inject=["restful","session"],b.permissions=function(a){var b={1:"school",2:"teacher",3:"student"},c={school:{users:["add","edit","remove","view"],activities:["add","edit","remove","view"],subjects:["add","edit","remove","view"],news:["add","edit","remove","view"],lessons:["view"],questions:["view"],answers:["view"],logs:["view"]},teacher:{lessons:["add","edit","remove","view","start","results"],activities:["view"],news:["view"],questions:["add","edit","remove","view"],answers:["add","edit","remove","view"]},student:{lessons:["view","join","results"],news:["view"],activities:["view","register"]}};return{getAllowedSections:function(){return c[b[a.getUserType()]]||{}},getAllowedActions:function(d){var e=c[b[a.getUserType()]];return e&&e[d]?e[d]||[]:[]},can:function(d,e){var f=!1,g=c[b[a.getUserType()]];return g[e]&&(f=-1!==g[e].indexOf(d)),f}}},b.permissions.$inject=["session"],b.questions=function(a){return angular.extend(b.abstract.api(a,"questions"),{getForLesson:function(b){return a.query("/questions",{lesson_id:b})}})},b.questions.$inject=["restful"],b.registrations=function(a,c){return angular.extend(b.abstract.api(a,"registrations"),{add:function(b){return b.student_id=c.getId(),a.query("/registrations/create",b)}})},b.registrations.$inject=["restful","session"],b.resources=function(a){return angular.extend(b.abstract.api(a,"resource"),{getForLesson:function(b){return a.query("/resource",{lesson_id:b})}})},b.resources.$inject=["restful"],b.restful=function(a){function b(b,d){return a({url:c+b,params:d,method:"GET",widthCredentials:!0})}var c=e.app.getServerUrl();return{query:b}},b.restful.$inject=["$http"],b.results=function(a){return angular.extend(b.abstract.api(a,"results"),{getForLesson:function(b){return a.query("/results",{lesson_id:b})},getForStudent:function(b,c){return a.query("/results",{lesson_id:b,user_id:c})}})},b.results.$inject=["restful"],b.session=function(a){function b(b){c=b.id,d=b.username,e=b.user_type,a.put("user",b)}var c,d,e,f=a.get("user");return f&&b(f),{getId:function(){return parseInt(c)},getUsername:function(){return d},getUserType:function(){return e},create:b,destroy:function(){c=null,d=null,e=null,a.put("user",null)}}},b.session.$inject=["$cookieStore"],b.subjects=function(a){return b.abstract.api(a,"subjects")},b.subjects.$inject=["restful"],b.toasts=function(a){function b(b,c){a.$emit("toast",{type:b,message:c})}return{message:function(a){b("primary",a)},info:function(a){b("info",a)},success:function(a){b("success",a)},warning:function(a){b("warning",a)},error:function(a){b("danger",a)}}},b.toasts.$inject=["$rootScope"],b.users=function(a){var c=b.abstract.api(a,"users");return c.login=function(b,c){return a.query("/login",{username:b,password:c})},c.logout=function(){return a.query("/logout")},c},b.users.$inject=["restful"],angular.module(e.app.name,e.app.modules).config(e.routes).run(e.access),function(b,c){for(c in a)"abstract"!==c&&b.controller(c,a[c])}(angular.module(e.app.name+".controllers",[e.app.name+".services"])),function(a,b){for(b in d)"abstract"!==b&&a.directive(b,d[b])}(angular.module(e.app.name+".directives",[])),function(a,c){for(c in b)"abstract"!==c&&a.factory(c,b[c])}(angular.module(e.app.name+".services",[]))}();